@page "/restaurants"
@page "/"

@using AirtableApiClient
@using EugeneFoodScene.Data
@implements IDisposable

@inject ClientCache cache

@if (cache.FoundPlaces == null)
{
    <p><em>Loading...</em></p>
}
else
{

    <div class="d-flex home-flex">
        <RadzenFieldset Text="Filter" class="col-3">
            <RadzenFieldset Text="Delivery or Take-Out" >
                <RadzenSelectBar TValue="IEnumerable<string>" class="flex-row"  @bind-Value="@_selectedMethods"  
                                 Change="ChangeMethod" >
                    <Items>
                        <RadzenSelectBarItem Text="Delivery" Value="@DeliveryMethods.Delivery"/>
                        <RadzenSelectBarItem Text="Pickup" Value="@DeliveryMethods.Pickup"/>
                    </Items>
                </RadzenSelectBar>
            </RadzenFieldset>
            <RadzenFieldset Text="Cuisine" >
                <RadzenSelectBar TValue="IEnumerable<string>" class="flex-row" Multiple="true"  @bind-Value="@_selectedCuisines"
                                 Change="ChangeCuisine" >
                    <Items>
                        @foreach (var item in cache.Cuisines)
                        {
                            <RadzenSelectBarItem Text="@item.Name" Value="@item.Id"/>
                        }
                    </Items>
                </RadzenSelectBar>
            </RadzenFieldset>
            <RadzenFieldset Text="Category" >
                <RadzenSelectBar TValue="IEnumerable<string>" class="flex-row" Multiple="true">
                    <Items>
                        @foreach (var item in cache.Categories)
                        {
                            <RadzenSelectBarItem Text="@item.Name" Value="@item.Id"/>
                        }
                    </Items>
                </RadzenSelectBar>
            </RadzenFieldset>
            <span>
                <RadzenCheckBox TValue="bool"/>
                <RadzenLabel Text="Location" Style="margin-left: 5px; margin-bottom: 20px"/>
            </span>
            <span>
                <RadzenCheckBox TValue="bool"/>
                <RadzenLabel Text="Curbside" Style="margin-left: 5px; margin-bottom: 20px"/>
            </span>
        </RadzenFieldset>
        <RadzenFieldset Text="Resturants">
            <RadzenDataList WrapItems="true" AllowPaging="true" Data="@cache.FoundPlaces" TItem="Place" PageSize="12" >
                <Template Context="place">
                    <RadzenCard>

                        <b><RadzenLink Text="@place.Name" Path="@($"restaurant/{place.Id}")"></RadzenLink></b>
                        <RadzenLabel Text="Phone:"></RadzenLabel>
                        <b>@place.Phone</b>
                        <RadzenLabel Text="Cuisines:"></RadzenLabel>
                        <b>@place.CuisineDisplay</b>
                        <RadzenLabel Text="Delivery Services:"></RadzenLabel>
                        <b>@place.DeliveryOptionsDisplay</b>
                        <RadzenLabel Text="Address:"></RadzenLabel>
                        <b>@place.Address</b>

                    </RadzenCard>
                </Template>
            </RadzenDataList>
        </RadzenFieldset>
    </div>

}

@code {

    IEnumerable<string> _categories = new string[] {};
    IEnumerable<string> _selectedCuisines = new string[] {};
    IEnumerable<string> _selectedMethods = new string[] { "delivery","pickup" };


    protected override async Task OnInitializedAsync()
    {
        await cache.GetFoundPlaces();
        await cache.GetCategories();
        await cache.GetCuisines();
    }

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            cache.CacheUpdated += OnCacheUpdated;
        }

    }

    public void OnCacheUpdated(object sender, EventArgs e)
    {
        this.StateHasChanged();
    }

    public void Dispose() {
        cache.CacheUpdated -= OnCacheUpdated;
    }

    public async void ChangeCuisine()
    {
        await cache.FilterCuisine(_selectedCuisines);
    }

    public async void ChangeMethod()
    {
        await cache.FilterMethod(_selectedMethods);
    }
}
